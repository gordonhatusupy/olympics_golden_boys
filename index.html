<!DOCTYPE html>
<html>
<head>
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="style.css">
    <script src='lib/d3.min.js'></script>
    <meta charset='utf-8'>
    <title></title>
</head>
<body>
<h1>The Olympic Golden Boys</h1>

<div id="inputfield">
    <input type="text" name="fname"><br>
</div>

<div id="svgcontainer">
    <svg id="viz">
        <filter id="multiply-effect">
            <feBlend mode="multiply" in1="BackgroundImage"/>
        </filter>
    </svg>

    <svg id="medal_graph"></svg>
</div>

<script>

    d3.csv('data/olympics_2012.csv', function(data) {

        // Given a value and the total return the percentage
        function percentage(value, total) {
            return d3.round((value / total) * 100, 2);
        }

        // Ugly code to return the athletes per bin
        function bin(values) {
            return (values.to20 + ' ' + values.to30 + ' ' + values.to40 + ' ' + values.to50 + ' ' + values.to60 + ' ' + values.to70 + ' ' + values.to80);
        }

        // Great work! We should see if we can refactor this to a case/switch statement to improve readability and performance if possible
        // TODO deal with the 'undefined' value
        function cluster(d) {

                    if (d.Sport.substr(0,3) == "Mod" || d.Sport.substr(0,3) == 'Ath' ||  d.Sport.substr(0,3) == 'Tri') {
                        return "Athletics";
                    }else if ( d.Sport.substr(0,3) == 'Cyc' ) {
                        return "Cycling";
                    }else if ( d.Sport.substr(0,3) == 'Can' ) {
                        return "Canoe";
                    }else if ( d.Sport.substr(0,3) == 'Div' || d.Sport.substr(0,3) == 'Wat' || d.Sport.substr(0,3) == 'Syn' || d.Sport.substr(0,4)=="Tram") {
                        return "Swimming";
                    }else if ( d.Sport.substr(0,3) == 'Tae' || d.Sport.substr(0,3) == 'Wre' || d.Sport.substr(0,3) == 'Jud') {
                        return "Martial Arts";
                    }else if ( d.Sport.substr(0,3) == 'Gym' ) {
                        return "Gymnastics";
                    }else if ( d.Sport.substr(0,5) == 'Beach' ) {
                        return "Volleyball";
                    }else{
                        return d.Sport;
                    }                

        }


        // we use this to set a default height for any horizontal bar, so we can change it in a single place
        var barHeight = 30;

        // We use this to set how wide the complete horizontal bar should be, again to change it in a single place
        var elementWidth = 200;

        // How many females?
        var sumFemale =  function(d){
           return d3.sum(d, function(c){
               return (c.Sex == 'F') ? 1 : 0
           })
        };

        // How many males?
        var sumMale =  function(d){
            return d3.sum(d, function(c){
                return (c.Sex == 'M') ? 1 : 0
            })
        };

        // How many gold medals?
       var sumGold =  function(d){
            return Math.round( 
                d3.sum(d, function(c){
                    return c.Gold;
                })
            )                                      
        };

        // How many silver medals?
       var sumSilver =  function(d){
            return Math.round( 
                d3.sum(d, function(c){
                    return c.Silver;
                })
            )                                      
        };  

        // How many bronze medals?
       var sumBronze =  function(d){
            return Math.round( 
                d3.sum(d, function(c){
                    return c.Bronze;
                })
            )                                      
                };

        // function to return the number of athletes with age between min and max as integers
        var ageBin = function(d, min, max) {
            return d3.sum(d, function(c){
                if (parseInt(c.Age) >= min && parseInt(c.Age) < max) {
                    return 1
                }
                else
                {
                    return 0
                }
            })
        };
        
        
        var country = 'Italy'; //for testing purposes, needs to be replaced by user choice

        // starting data, clustered and rolled up
        var sportData = d3.nest()
                .key(function (d) {
                    if (country == 'All') { //get data for all countries
                        return cluster(d);
                    }else { //get data for specific country
                        if (d.Country == country) {
                            return cluster(d);
                        }
                    }
                })
                .rollup(function (d) {
                    return {
                        female: sumFemale(d),
                        male: sumMale(d),
                        gold: sumGold(d),
                        silver: sumSilver(d),
                        bronze: sumBronze(d),
                        to20: ageBin(d, 10, 20),
                        to30: ageBin(d, 20, 30),
                        to40: ageBin(d, 30, 40),
                        to50: ageBin(d, 40, 50),
                        to60: ageBin(d, 50, 60),
                        to70: ageBin(d, 60, 70),
                        to80: ageBin(d, 70, 80),
                        athletes: d
                    }
                })
                .sortKeys(d3.ascending)
                .entries(data);

        function countMedals(dataset) {
            console.log(dataset)
            var sumG = 0.;            
            var sumS = 0.;
            var sumB = 0.;
            for (i=0; i<dataset.length; i++){
                sumG += dataset[i].values.gold;
                sumS += dataset[i].values.silver;
                sumB += dataset[i].values.bronze;
            }
            return [sumG, sumS, sumB];
        }

        // post the data to the console for inspection
        //console.log(sportData);
        //console.log(countGold(sportData));

        // This function gets called every time we refilter the data
        function update( _data ) {

            // we use this to get the total size of the dataset
            // TODO this needs to update based on the selected country
            var totalAthletes = data.length;

            // The scale for the sex graph
            var scaleSex = d3.scale.linear()
                    .domain([0, 100])
                    .range([0, elementWidth]);

            // The scale for the age graph
            var scaleAge = d3.scale.linear()
                    .domain([10, 80])
                    .range([0, elementWidth]);

            // The scale for the sports presence
            var scalePresence = d3.scale.linear()
                    .domain([0, 100])
                    .range([0, elementWidth]);

            // initial selection

            var nmedals = countMedals(_data);
            console.log(nmedals[0])
            var ngold = nmedals[0];
            var nsilver = nmedals[1];
            var nbronze = nmedals[2];

            console.log(ngold)

            var ncircleG = [];
            for(var i=0; i<ngold; i++){
                ncircleG[i] = i;
            }
            var ncircleS = [];
            for(var i=0; i<nsilver; i++){
                ncircleS[i] = i;
            }
            var ncircleB = [];
            for(var i=0; i<nbronze; i++){
                ncircleB[i] = i;
            }

            console.log(ncircleG)

            var sports = d3.select('svg')
                    .selectAll('g')
                    .data(_data, function (d) {
                        return d.key;
                    });

            var medal_graph_gold = d3.select('#medal_graph')
                    .selectAll('circle')
                    .data(ncircleG, function (d, i) {
                        return i
                    });

            var medal_graph_silver = d3.select('#medal_graph')
                    .selectAll('circle')
                    .data(ncircleS, function (d, i) {
                        return i
                    });

            var medal_graph_bronze = d3.select('#medal_graph')
                    .selectAll('circle')
                    .data(ncircleB, function (d, i) {
                        return i
                    });

            var blaat = [0, 1, 2]
            var medal_graph_label = d3.select('#medal_graph')
                    .selectAll('g')
                    .data(blaat, function(d, i){
                        return d
                    })

            // enter on initial selection
            // appends groups
            // console.log(ncircle)
            medal_graph_label.enter()
                    .append('text')
                    .data(blaat)
                    .text("medal_type")
                    .attr('y', function(d, i){
                        return 25 + (i * 20)
                    })

            medal_graph_gold.enter()
                    .append('circle')
                    .attr('class', 'gold_medal')
                    .attr('r', 4)
                    .attr('cy', 20)
                    .attr('cx', function (d, i){
                        return 20 + (i * 4) 
                    })

            medal_graph_silver.enter()
                    .append('circle')
                    .attr('class', 'silver_medal')
                    .attr('r', 4)
                    .attr('cy', 40)
                    .attr('cx', function (d, i){
                        return 20 + (i * 4) 
                    })

            medal_graph_silver.enter()
                    .append('circle')
                    .attr('class', 'bronze_medal')
                    .attr('r', 4)
                    .attr('cy', 60)
                    .attr('cx', function (d, i){
                        return 20 + (i * 4) 
                    })

            sports.enter()
                    .append('g')
                    .attr('transform', function (d, i) {
                        return ('translate(0,' + i * 21 + ')');
                    });

            // add the sports + medals
            sports.append('text')
                    .text(function (d) {
                        return d.key;
                    });

            // add the female to male numbers
            sports.append('text')
                    .attr('x', '200')
                    .text(function (d) {
                        return (d.values.female + ' to ' + d.values.male);
                    });

            // add the total presence of the sport
            sports.append('text')
                    .attr('x', '400')
                    .text(function (d) {
                        return (d.values.athletes.length + ' of ' + totalAthletes + ' (' + percentage(d.values.athletes.length, totalAthletes) + ')' );
                    });

            // add the binned ages
            sports.append('text')
                    .attr('x', '600')
                    .text(function (d) {
                        return bin(d.values);
                    });

            // exit on initial selection
            sports.exit()
                    .remove();
        }

        // This actually draws our graph by triggering the update function
        // TODO wrap this in a binding to the user interface element, for selection to work
        update(sportData);
    });

</script>
</body>
</html>